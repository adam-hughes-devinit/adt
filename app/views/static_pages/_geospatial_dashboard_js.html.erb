<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
<%= javascript_include_tag   "humanity_united/mapbox" %>
<%= javascript_include_tag   "humanity_united/jquery-ui-1.10.4.custom.min" %>
<%= stylesheet_link_tag "humanity_united/mapbox" %>
<%= stylesheet_link_tag "humanity_united/ui-lightness/jquery-ui-1.10.4.custom.min" %>
<style>
    .container {width:100% !important;padding:0px !important;}
    #vis { width:100%; height:100%; margin-right:auto; margin-left:auto;}
    #map { position:absolute; height:100%; width:100%; margin-right:auto;margin-left:auto; }
    #searchbar {width:40%;position:absolute;left:10px;opacity:0.9;padding-left:2px;}
    #searchbar .vissearch {width:100%;margin-bottom:0px !important;box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px;border-radius:0px;}
    #searchbar form {position:relative; right:10px; margin-bottom: 1px;height:32px;}
    #left {float:left;width:18%}
    #searchresults {float:left;position:relative;top:35px;height:auto;width:100%;padding:1px;overflow-y:scroll;background-color:#FFF;opacity:0.9;max-height:600px;box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px; left:2px;z-index:1;}
    #filtercontrol ol, #filtercontrol ul {margin:0 0 10px 10px;}
    #filtercontrol {float:right;position:relative;right:2px;top:3px;box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px;height:auto;width:18%;padding:1px;background-color:#FFF;opacity:0.9;overflow-y:scroll;max-height:600px;}
    h4 {margin-left:5px;float:left;}
    #searchresults #results, #resultcount, #resultRight{margin:0 10px 0 10px;}
    form.leaflet-control-layers-list{margin:0px !important;}
    .info {padding: 6px 8px;background: rgba(255,255,255,0.9);box-shadow: 0 0 15px rgba(0,0,0,0.2);}
    .info h4 {margin: 0 0 5px;color: #777;}
    .legend {text-align: left;line-height: 18px;color: #555;}
    .legend i {width: 18px;height: 18px;float: left; margin-right: 8px;opacity: 0.7;}
    .leaflet-disabled{background-color:lightgrey;}
    .ui-widget{z-index:9997 !important;}
    img.loading{z-index:9999;display:none;position:absolute;top:50%;right:50%;}
    div.loading{z-index:9998;display:none;background-color:grey;position:absolute;opacity:0.4;height:100%;width:100%;overflow:hidden;}
    div.leaflet-control-zoom {left:0px !important;top:25px !important;box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px;border-radius:0px !important;}
    div.leaflet-left {margin-left:18% !important}
    div.leaflet-control-layers {right:3px !important;top:1px !important;margin-top:2px !important;margin-right:18%;opacity:0.9;box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px;border-radius:0px;}
    div.leaflet-right.leaflet-top {margin-right:18% !important}
    #watermark{position:absolute;bottom:0px;left:0px;z-index:0;}
    div.leaflet-popup-content-wrapper{box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px;border-radius:5px;opacity:0.9;}
    div.leaflet-popup-content{opacity:0.9;}
    div.leaflet-popup-tip-container{width:44px;height:25px;}
    div.leaflet-popup-tip{box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px;border-radius:20px;opacity:0.9;height:10px;width:30px;}
    #page_select{text-align:center;margin-left:auto;margin-right:auto;}
    #page{text-align:center;margin-left:auto;margin-right:auto;}
    .btn{opacity:0.9;box-shadow:0 0 15px rgba(0,0,0,0.2);border: solid rgba(0,0,0,0.2) 1px;border-radius:0px;position:relative;top:-32px;left:100%;}
    .project{cursor:pointer;}
    hr{margin:5px !important;}
    #resultsBtn, #filterBtn{text-align:center;cursor:pointer;background-image:url(/assets/humanity_united/icons-000000.png);background-position:0 -52px;background-repeat:no-repeat;width:26px;height:26px;float:right;}
    .plus{background-position:0px 0px !important;}
    .leaflet-control-layers-expanded{padding:5px !important;}
    #layerBtn{float:right;cursor:pointer;background-image:url(/assets/humanity_united/icons-000000.png);background-position:0px -54px;background-repeat:no-repeat;width:26px;height:28px;}
    .layerCollapse{background-position:0px -104px !important;}
    div.leaflet-control-layers-base{float:left;}
    .header{width:100%;float:left;}
    .leaflet-bar a{border-radius:0px !important;}
    #resultLeft{overflow:hidden;position:relative;left:0;}
    #resultRight{overflow:hidden;position:relative;left:100%;display:none;}
</style>
<div class="loading"></div>
<div id="vis">
  <img class="loading" src='/assets/humanity_united/loading.gif' alt='loading'>
    <div id="searchbar" class="ui-widget">
      <%= form_tag "/queries/geospatial_search", id: "geospatial_search", method: :get, remote: true do %>
            <%= text_field_tag :search, params[:search], placeholder: 'Search for projects and locations by keyword...', class:'vissearch' %>
            <%= submit_tag "Search", name: nil, class: "btn btn-primary span2" %>
      <% end %>
    </div>
  <script>
//AJAX loading screen
    var toggleLoading = function(){$(".loading").toggle();$( "#search" ).autocomplete("close");};
      $('#geospatial_search')
              .bind("ajax:beforeSend", toggleLoading)
              .bind("ajax:complete", toggleLoading)
              .bind("ajax:success",function(xhr,data,status){
//Take AJAX data and draw it, zoom to it
              feature_collection = data.features
              geoJson.clearLayers()
              geoJson.addData(feature_collection.features)
              drawResults(data)
              results = data
              if(feature_collection.features.length>0){
                  if(Object.keys(geoJson._layers).length>0){
                      var bounds = geoJson.getBounds()
                      zoomToFeature(bounds)
                  }
              }
                  else{
                  map.fitBounds([[52,68],[-42,-29]])
                  $('#resultcount').html("<strong>No search results.</strong>")
              }
              })
//Autocomplete function
      $(document).ready(function(){
          $( "#search" ).autocomplete({
              source: get_keywords,
              minLength: 1
          });
      });
      function get_keywords(request, response){
          var params = {keywords: request.term.split(/(?:\(.*?\))+/)[0]};
          $.get("/queries/json_completion", params, function(data){
              response(data); }, "json");
      }
  </script>
    <div id='map'>
    </div>
    <div id="left">
      <div id="searchresults">
        <div class="header">
        <h4>Results</h4><div id="resultsBtn" onclick="$('#resultSlider').slideToggle();$('#resultsBtn').toggleClass('plus')"></div>
        </div>
          <div id="resultcount"></div>
       <div id="resultSlider">
        <div id="resultLeft">
        <div id="results"></div>
        <div id="page"><strong>Page _ of _</strong></div>
        <div id="page_select">&lt;first &lt;prev <a href='#'>next&gt; </a><a href='#'>last&gt;</a></div>
        </div>
        <div id="resultRight">
          <a href='#' onclick='backToResults();'>&lt;Back to results</a>
          <hr>
          <div id="projectPage">
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          Project Page<br>
          </div>
        </div>
       </div>
      </div>
      <%= javascript_tag "var results=#{@first_page.to_json}"%>
      <%= javascript_tag "var feature_collection=#{@feature_collection.to_json}"%>
      <script>
//Function to draw results in the panel
        drawResults = function(results){
            $('#resultcount').html("<strong>"+results.entries+" projects -</strong>")
            $('#resultcount').append("<br>with "+feature_collection.features.length+" geocodes:<hr>")
            $('#page strong').text("Page "+results.current+" of "+results.pages)
            $('#results').html("")
            var i = 0,
                    resultlen = results.data.length;
            for(i=0;i<resultlen;i++){
                var project = results.data[i],
                        geoCount = 0,
                        truncTitle = project.title.split(' ').length>5?project.title.split(' ').slice(0,6).join(' ')+'...':project.title;
                feature_collection.features.forEach(function(e){
                    geoCount += e.properties.project_id==project.id?1:0
                })
                $('#results').append("<div class='project' onmouseover='highlightProjectHover("+project.id+")' onmouseout='resetHighlightProjectHover("+project.id+")' onclick='clickHighlightProject("+project.id+")'>ID: <a target='_blank' href='/projects/"+ project.id + "'>"+project.id+"</a><br>"+truncTitle+"<br>Geocodes: "+geoCount+"/"+project.geocodes.length+"</div>")
                $('#results').append("<hr>")
            }
//Draw page buttons
            $('div#page_select').html("")
            if(results.current<=1){
                $('div#page_select').append("&lt;first &lt;prev ")
            }
            else{
                $('div#page_select').append("<a href='#' onclick='pageFirst()'>&lt;first</a> <a href='#' onclick='pagePrev()'>&lt;prev</a> ")
            }
            if(results.current>=results.pages){
                $('div#page_select').append("next&gt; last&gt;")
            }
            else{
                $('div#page_select').append("<a href='#' onclick='pageNext()'>next&gt; </a><a href='#' onclick='pageLast()'>last&gt;</a>")
            }
        }
//Functions to control page movement
        pageFirst = function(){
            var params = {'ids[]': results.ids, page:1};
            $.post("/queries/geo_page", params, function(data){
                results = data
                drawResults(results); }, "json");
        }
        pagePrev = function(){
            var params = {'ids[]': results.ids, page: results.current - 1};
            $.post("/queries/geo_page", params, function(data){
                results = data
                drawResults(results); }, "json");
        }
        pageNext = function(){
            var params = {'ids[]': results.ids, page: results.current + 1};
            $.post("/queries/geo_page", params, function(data){
                results = data
                drawResults(results); }, "json");
        }
        pageLast = function(){
            var params = {'ids[]': results.ids, page: results.pages};
            $.post("/queries/geo_page", params, function(data){
                results = data
                drawResults(results); }, "json");
        }
        drawResults(results)
      </script>
    </div>
  <div id="filtercontrol">
    <div class="header"><h4>Filter</h4><div id="filterBtn" onclick="$('#filterSlider').slideToggle();$('#filterBtn').toggleClass('plus')"></div></div>
    <div id="filterSlider">
    <div id="project-facets">
      <div class="pull-left">
        <ol>
          <div class="search-facet">
            <b class="facet-header">
              <a href="#" onclick="$(this).parent().siblings('ul').slideToggle(); $(this).parent().siblings('.facet-controller').slideToggle(); return false;">Year</a>
            </b>
            <span class="check_count project_year"></span>
            <a class="facet-controller" id="project_years_on" href="#" onclick="$(this).siblings('ul').find('input').prop('checked', 'true');update_check_counter_for('project_year'); return false;" style="display: none;">Select all</a>
            <a class="facet-controller" id="project_years_off" href="#" onclick="$(this).siblings('ul').find('input').prop('checked', false);update_check_counter_for('project_year'); return false;" style="display: none;">Unselect all</a>
            <ul id="yearfilter" class="unstyled facet-list" style="display: none;"></ul>
            <script>
                //Update check-box count
                function update_check_counter_for(this_facet) {
                    checked_boxes = $(".search_check."+this_facet+":checked")
                    check_count = checked_boxes.length
                    counter = $('.check_count.'+this_facet)
                    counter_text = check_count > 0 ? "("+check_count+")" : ""
                    counter.text(counter_text)

                }
                //Draw checkboxes for year
                var project_years = ["2012","2011","2010","2009","2008","2007","2006","2005","2004","2003","2002","2001","2000"],
                        project_years_len = project_years.length;
                for(var i=0;i<project_years_len;i++){
                    $('ul#yearfilter').append("<li class='facet-list-item'><label class='checkbox'><input type='checkbox' checked='true' name='project_year' value='"+(project_years[i])+"' class='search_check boolean project_year'>"+(project_years[i])+"</label></li>")
                }
                update_check_counter_for('project_year')
                $('.facet-list-item').click(function() {
                    this_facet = $(this).find('.search_check').attr("name").replace(/\[\]/g, '')
                    update_check_counter_for(this_facet)
                })
            </script>
          </div>
        </ol>
      </div>
    </div>
    </div>
  </div>
  <div id="watermark">
    <a href="/"><%= image_tag("open_adt_small.png", width: "300") %></a>
  </div>
</div>
<script>
//Set-up layers
    function getAdm(level,code){
        var layer = L.tileLayer('http://china-tilestache.aiddata.org/{shp}/{z}/{x}/{y}.png', {
            shp: 'adm'+level+'_'+code,
            noWrap:true,
            opacity:0.7
        });
        if(level!==undefined && code!==undefined && level!="0") {
            return layer;
        }
        else{
            return L.geoJson();
        }
    }
    var MapQuest = L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg', {
                attribution: 'Tiles by <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                subdomains: '1234',
                noWrap:true
            }),
            OSM = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
                noWrap:true
            });
            none = L.geoJson(),
            poverty = L.mapbox.tileLayer('miranda-lv.di996bt9', {
                noWrap:true,
                opacity:0.7
            }),
//sudo ./scripts/tilestache-server.py -c adm.cfg
//sudo python ./scripts/tilestache-seed.py -c dashboard.cfg -b -42 -29 52 68 -l usgs 0 1 2 3 4 5 6 7 8 9 10 11 12 13
//sudo python ./scripts/tilestache-seed.py -c dashboard.cfg -b -42 -29 52 68 -l acled 0 1 2 3 4 5 6 7 8 9 10 11 12 13
        acled = L.tileLayer('http://china-tilestache.aiddata.org/acled/{z}/{x}/{y}.png', {
                attribution: "Base layer data from <a href='http://www.acleddata.com/'>ACLED</a>",
                noWrap:true,
                opacity:0.7
            }),
            usgs = L.tileLayer('http://china-tilestache.aiddata.org/usgs/{z}/{x}/{y}.png',{
                attribution: "Base layer data from <a href='http://tin.er.usgs.gov/mrds/'>USGS MRDS</a>",
                noWrap:true
            }),
//Set-up map
            map = L.map('map', {
                maxBounds: [[180,180],[-180,-180]],
                center: [6.964039, 19.533678],
                zoom:3,
                minZoom:3,
                maxZoom:13,
                layers:MapQuest
            }),
            baseMaps ={
                "None": none,
                "Poverty": poverty,
                "Armed Conflict": acled,
                "Minerals and Mines": usgs
            },
//Set-up GeoJson
            MarkerOptions = {
            radius: 4,
            fillColor: "#9FE5F8",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.5};
//Set-up Leaflet Controls
    map.addLayer(none);
    var layerControl = L.control.layers(baseMaps);
    layerControl.options.collapsed = false;
    layerControl.addTo(map);
    layerControl.collapse = function(){
        $('div.leaflet-control-layers-base').slideToggle()
        $('#layerBtn').toggleClass('layerCollapse')
    }
function fullExtent(event){
    event.preventDefault();
    map.fitBounds([[52,68],[-42,-29]])
    return false;
}
$('.leaflet-control-zoom').prepend("<a href='#' style='font-weight:bold;text-align:center;' onclick='fullExtent(event)'><span style='position:relative;top:3px;'>Full</span></a>");
$('.leaflet-control-layers-list').prepend("<div id='layerBtn' onClick='layerControl.collapse()'></div>")
    function getColorPoverty(d) {
        return d > 79.9  ? '#FF0202' :
                        d > 59.9   ? '#FA5A5A' :
                        d > 39.9   ? '#F78282' :
                        d > 19.9   ? '#F5AAAA' :
                '#F6CECE';
    }
    function getColorConflict(d) {
        return d == "High"  ? '#BD0228' :
                        d == "Medium"   ? '#F4582B' :
                        d == "Low"   ? '#FDB853' :
                '#FFFFB3';
    }
    var legend = L.control({position: 'bottomright'});
//GeoJson Functions
function highlightFeature(e) {
    var layer = e.target,
        feature = layer.feature;
    layer.setStyle({
        weight: 3
    });
};
function resetHighlight(e) {
    var layer = e.target;
    layer.setStyle({
        weight: 1
    });
};
function highlightProjectHover(project){
    geoJson.setStyle(function(feature){
        var thisProject = feature.properties.project_id;
        switch (thisProject){
            case project: return {
                color: "#f1f89f",
                weight: 20,
                opacity: 0.9,
                fillOpacity: 0
            };
        }
    });
};
function resetHighlightProjectHover(project){
    geoJson.setStyle(function(feature){
        var thisProject = feature.properties.project_id;
        switch (thisProject){
            case project: return {
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.5
            };
        }
    });
};
function clickHighlightProject(project) {
    var params = {'id': project};
    $.post("/queries/micro_project", params, function(data){
        microProjectData = data
        drawProject(microProjectData);}, "json");
};
function highlightGeocode(geocode){
    geoJson.setStyle(function(feature){
        var thisGeocode = feature.properties.geo_code_id;
        switch (thisGeocode){
            case geocode: return {
                color: "#f1f89f",
                weight: 20,
                opacity: 0.9,
                fillOpacity: 0
            };
        }
    });
};
function resetHighlightGeocode(geocode){
    geoJson.setStyle(function(feature){
        var thisGeocode = feature.properties.geo_code_id;
        switch (thisGeocode){
            case geocode: return {
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.5
            };
        }
    });
};
function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
};
function drawProject(microProjectData){
//Build Feature Collection
    var features = [],
            project = microProjectData[0].project;
    oldFeatures = feature_collection.features;
    microProjectData.forEach(function(geocode){
        var featureObj = {};
        featureObj.type = "Feature"
        featureObj.geometry = {}
        featureObj.geometry.coordinates = [parseFloat(geocode.lon),parseFloat(geocode.lat)]
        featureObj.geometry.type = "Point"
        featureObj.properties = {}
        featureObj.properties.adm_code = geocode.adm_code
        featureObj.properties.adm_level = geocode.adm_level
        featureObj.properties.adm_name = geocode.adm_name
        featureObj.properties.geo_code_id = geocode.geo_code_id
        featureObj.properties.geo_name = geocode.geo_name
        featureObj.properties.location_type = geocode.location_type
        featureObj.properties.precision_code = geocode.precision_id
        featureObj.properties.project_id = geocode.project.id
        featureObj.properties.project_year = geocode.project.year
        features.push(featureObj)
    })
    feature_collection.features = features
//Redraw map and zoom
    geoJson.clearLayers()
    geoJson.addData(feature_collection.features)
    if(feature_collection.features.length>0){
        if(Object.keys(geoJson._layers).length>0){
            var bounds = geoJson.getBounds()
            zoomToFeature(bounds)
        }
    }
    else{
        map.fitBounds([[52,68],[-42,-29]])
    }
//Draw Project Page
    $('#projectPage').html("")
    $('#projectPage').append("<span style='text-decoration:underline;'>"+project.title+"</span><br><br>")
    $('#projectPage').append("<b>ID:</b> <a target='_blank' href='/projects/"+ project.id + "'>"+project.id+"</a><br>")
    $('#projectPage').append("<b>Year:</b> "+project.year+"<br>")
    for(var i=0;i<project.geopoliticals.length;i++){
        $('#projectPage').append("<b>Recipient:</b> "+project.geopoliticals[i].recipient.name+" - "+project.geopoliticals[i].percent+"%<br>")
    }
    $('#projectPage').append("<b>Amount (USD 2009):</b> $"+numberWithCommas(Math.ceil(project.usd_2009))+"<br>")
    $('#projectPage').append("<b>Status:</b> "+project.status_name+"<br>")
    $('#projectPage').append("<b>Scope:</b> "+project.oda_like_name+"<br>")
    $('#projectPage').append("<b>Sector:</b> "+project.crs_sector_name+"<br><hr>")
    for(var i=0;i<microProjectData.length;i++){
        var geocode = microProjectData[i],
                geoTreelen = geocode.geoTree===null?0:geocode.geoTree.length,
                geocodeHTML = "";
        geocodeHTML += ("<b>Geocode "+(i+1)+":</b> "+"<br>")
        for(var j=0;j<geoTreelen;j++){
            if(j==0){
                geocodeHTML += ("<span>"+geocode.geoTree[j]+"</span><br>")
            }else if(j==1){
                geocodeHTML += ("<span><img src='assets/humanity_united/arrow.gif'/>"+geocode.geoTree[j]+"</span><br>")
            }else{
                geocodeHTML += ("<span style='margin-left:13px'><img src='assets/humanity_united/arrow.gif'/>"+geocode.geoTree[j]+"</span><br>")
            }
        }
        geocodeHTML += ("<em>Geoname: </em>"+geocode.geo_name+"<br>")
        geocodeHTML += ("<em>Precision: </em>"+geocode.precision_id+"<br>")
        $('#projectPage').append("<div onmouseover='highlightGeocode("+geocode.geo_code_id+")' onmouseout='resetHighlightGeocode("+geocode.geo_code_id+")'>"+geocodeHTML+"</div>")
        if(i+1<microProjectData.length){
            $('#projectPage').append("<hr>")
        }
    }
    console.log(microProjectData)
//Slide Results Panel
    slideResults()
};
function slideResults(){
    var $lefty = $('#resultLeft'),
            $righty = $('#resultRight'),
            resulthtml =  $('#resultcount').text().length>12?"<b>Project Page</b><hr>":"<strong>"+results.entries+" projects -</strong><br>with "+feature_collection.features.length+" geocodes:<hr>";
    $lefty.slideToggle()
    $lefty.animate({left: parseInt($lefty.css('left'),10) == 0 ?-$lefty.outerWidth():0})
    $righty.slideToggle()
    $righty.animate({left: parseInt($righty.css('left'),10) == 0 ?$lefty.outerWidth():0})
    $('#resultcount').html(resulthtml)
};
function backToResults(){
    feature_collection.features = oldFeatures
    //Redraw map and zoom
    geoJson.clearLayers()
    geoJson.addData(feature_collection.features)
    if(feature_collection.features.length>0){
        if(Object.keys(geoJson._layers).length>0){
            var bounds = geoJson.getBounds()
            zoomToFeature(bounds)
        }
    }
    else{
        map.fitBounds([[52,68],[-42,-29]])
    }
//Slide Results Panel
    slideResults()
}
function highlightProject(e) {
//Change style and count geocodes with same project
    var popup = e.target._popup
    popup.setLatLng(e.target.getLatLng())
    geoJson.setStyle(MarkerOptions)
    var project = e.target.feature.properties.project_id,
        projectCount = 0;
    geoJson.setStyle(function(feature){
        var thisProject = feature.properties.project_id;
        projectCount+=thisProject==project?1:0
        switch (thisProject){
            case project: return {
                fillColor:"#f8a39f",
                radius:8
            };
        }
    });
//Establish subset for bounds and adm gathering
    geoJsonSubset.clearLayers();
    geoJsonSubset.options.filter = function(feature,layer){
        return feature.properties.project_id==project
    }
    geoJsonSubset.addData(feature_collection.features);
    if(Object.keys(geoJsonSubset._layers).length>0){
        var bounds = geoJsonSubset.getBounds()
        zoomToFeature(bounds)
    }
    var highlightedAdms = [],
            duplicateAdms = {},
            uniqueAdms = [];
    for(var layer in geoJsonSubset._layers){
        var layer_level = geoJsonSubset._layers[layer].feature.properties.adm_level
                layer_code = geoJsonSubset._layers[layer].feature.properties.adm_code,
                layer_precision = geoJsonSubset._layers[layer].feature.properties.precision_code,
                adm_level = typeof(layer_level)=="number"&&layer_precision>1?layer_level:undefined,
                adm_code = typeof(layer_code)=="number"&&layer_precision>1?layer_code:undefined;
        highlightedAdms.push(getAdm(adm_level,adm_code))
    }
    $.each(highlightedAdms, function(i, el) {
        if (!duplicateAdms[el.options.shp]) {
            duplicateAdms[el.options.shp] = true;
            uniqueAdms.push(el);
        }
    });
    if(typeof(adms)=="object"){map.removeLayer(adms)}
    adms = L.featureGroup(uniqueAdms);
    //adms.addTo(map);
};
function zoomToFeature(bounds){
    var extendPoint1 = new L.LatLng(bounds.getNorthEast().lat + 1, bounds.getNorthEast().lng + 1);
    var extendPoint2 = new L.LatLng(bounds.getNorthEast().lat - 1, bounds.getNorthEast().lng - 1);
    bounds.extend(extendPoint1);
    bounds.extend(extendPoint2);
    map.fitBounds(bounds,{maxZoom:9});
};
function onEachFeature(feature,layer){
    if(feature.properties && feature.properties.project_id && feature.properties.project_year && feature.properties.geo_name && feature.properties.precision_code){
        layer.bindPopup("<strong>Project ID: </strong><a target='_blank' href='/projects/"+ feature.properties.project_id + "'>"+feature.properties.project_id+"</a><br/><strong>Year: </strong>" + feature.properties.project_year + "<br/><strong>Location: </strong>" + feature.properties.geo_name + "<br/><strong>Precision: </strong>" + feature.properties.precision_code);
    }
        layer.on({
            mouseover:highlightFeature,
            mouseout:resetHighlight,
            click: highlightProject
        })
    }
if (feature_collection === null){
    console.log("Feature collection error.")
    feature_collection = {};
    feature_collection.features=[];}
var geoJson = L.geoJson(feature_collection.features, {
    onEachFeature: onEachFeature,
    pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, MarkerOptions);
    }
}),
    geoJsonSubset = L.geoJson(feature_collection.features, {
        onEachFeature: onEachFeature,
        pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, MarkerOptions);
        }
    });
map.addLayer(geoJson);
//Filter function
function filterGeoJson(filterObject){
    if(filterObject===undefined){
        geoJson.options.filter = undefined;
    }
    else{
        geoJson.options.filter = function(feature,layer){
            var metaFilterBoolean = true;
            for(var filter in filterObject){
                var values = filterObject[filter],
                        valueLen = values.length,
                        filterBoolean = false;
                for(var i=0;i<valueLen;i++){
                    filterBoolean = filterBoolean || feature.properties[filter] == values[i]
                };
                metaFilterBoolean = metaFilterBoolean && filterBoolean
            };
            return metaFilterBoolean;
        };
    }
    geoJson.clearLayers()
    geoJson.addData(feature_collection.features)
};
var filterObject = {"project_year":project_years};
//This can be changed to [type='checkbox'] when both fields are active
$("input[type='checkbox']").change(function(){
   var changedBox = this,
           attribute = $(changedBox).attr("name"),
           value = $(changedBox).attr("value"),
           onOff = $("input:checked[name="+attribute+"][value="+value+"]").length,
           index = filterObject[attribute].indexOf(value);
    if(onOff==1){
        if(index==-1){
            filterObject[attribute].push(value);
        }
    }
    else{
        if(index>-1){
            filterObject[attribute].splice(index,1);
        }
    }
    filterGeoJson(filterObject);
});
$("a.facet-controller#project_years_on").click(function(){
    var project_years = ["2012","2011","2010","2009","2008","2007","2006","2005","2004","2003","2002","2001","2000"]
    filterObject.project_year = project_years;
    filterGeoJson(filterObject);
});
$("a.facet-controller#project_years_off").click(function(){
    filterObject.project_year = [];
    filterGeoJson(filterObject);
});
//Legend show/hide and div height control
$(document).ready(function(){
    map.on("baselayerchange", function(layer){
        var selected_layer = layer;
        if(selected_layer.name=="None"){
            console.log("Selected layer: None")
            if (legend._map!=null){
                map.removeControl(legend);
            }
        }
        if(selected_layer.name=="Poverty"){
            console.log("Selected layer: Poverty")
            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend'),
                        grades = [0, 20, 40, 60, 80],
                        labels = [],
                        from, to;
                for (var i = 0; i < grades.length; i++) {
                    from = grades[i];
                    to = grades[i + 1];
                    labels.push(
                                    '<i style="background:' + getColorPoverty(from) + '"></i> ' +
                                    from + (to ? '&ndash;' + to + '%' : '%+'));
                }
                div.innerHTML = labels.join('<br>');
                return div;
            };
            if (legend._map!=null){
                map.removeControl(legend);
            }
            map.addControl(legend);
        }
        if(selected_layer.name=="Armed Conflict"){
            console.log("Selected layer: Armed Conflict")
            legend.onAdd = function(map){
                var div = L.DomUtil.create('div', 'info legend'),
                        grades = ["None", "Low", "Medium", "High"],
                        labels = [],
                        from, to;
                for (var i = 0; i < grades.length; i++) {
                    from = grades[i];
                    to = grades[i + 1];
                    labels.push(
                                    '<i style="background:' + getColorConflict(from) + '"></i> ' +
                                    from + (to ? '&ndash;' + to : '+'));
                }
                div.innerHTML = labels.join('<br>');
                return div;
            }
            if (legend._map!=null){
                map.removeControl(legend);
            }
            map.addControl(legend);
        }
        if(selected_layer.name=="Minerals and Mines"){
            console.log("Selected layer: Minerals and Mines")
            legend.onAdd = function(map){
                var div = L.DomUtil.create('div', 'info legend')
                        labels = [];
                labels.push('<i style="background:#A10202"></i>' + "Mine, past or present");
                labels.push('<i style="background:#ffffff;border:solid #02A102 2px;"></i>' + "Prospective mine");
                labels.push('<i style="background:#0202A1"></i>' + "Processing plant");
                labels.push('<i style="background:#ffffff;border:solid black 2px;"></i>' + "Unknown");
                div.innerHTML = labels.join('<br>');
                return div;
            }
            if (legend._map!=null){
                map.removeControl(legend);
            }
            map.addControl(legend);
        }
    })
})
</script>