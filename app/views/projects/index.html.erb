<% provide(:title, "Projects") %>
<% provide(:first_header, "View Projects") %>
<% current_url = "#{request.protocol}#{request.host_with_port}#{request.fullpath}".gsub(/\??page=\d+&*/, '') %>
<% joiner = current_url.index("?") ? "&" : "?" %>
<% def order_by_params(field)
	"order_by=#{field}&dir=#{params[:dir]=="asc" ? "desc" : "asc"}"
end
%>
<% def active_or_inactive(project)
	if !project.active 
		"<span class='inactive-project-title'>#{project.title} (Inactive)</span>".html_safe
	else
		project.title
	end
end %>
	
<h2>Search Parameters</h2>
<%= render 'project_search' %>
<br>
<div class='row'>
	<h2><%= pluralize(@search.total, "Project") %> (<%= link_to "export as CSV", current_url.gsub(/projects/, 'projects.csv')%>)</h2>
	<%= will_paginate @projects %>
	
</div>
<br>
<table id="project-search-results">
	<thead>
		<tr >
			<% current_url_with_joiner_without_ordering = "#{current_url.gsub(/&?dir=[a-z]+/, '').gsub(/&?order_by=[0-9a-z_]+/, '')}#{joiner}" %>
			<th><%= link_to "Donor","#{current_url_with_joiner_without_ordering}#{order_by_params("donor_name")}"  %></th>
			<th><%= link_to "Title","#{current_url_with_joiner_without_ordering}#{order_by_params("title")}"  %></th>
			<th><%= link_to "Year","#{current_url_with_joiner_without_ordering}#{order_by_params("year")}"  %></th>
			<th><%= link_to "Recipients","#{current_url_with_joiner_without_ordering}#{order_by_params("recipient_condensed")}"  %></th>
			<th><%= link_to "Amount (USD-2009)","#{current_url_with_joiner_without_ordering}#{order_by_params("usd_2009")}"  %></th>
			<% if current_user %>
				<th>Links</th>
			<% end %>
		</tr>
	</thead>
	<tbody>
	    <% @projects.each do |p| %>
	    	<tr>
	    		<td><%= p.donor ? p.donor.name : 'Unset' %> </td>
	    		<td><%= link_to active_or_inactive(p), p %></td> 
	    		<td><%= p.year %></td>
	    		<td><%= p.country_name.join(', ') %></td>
	    		<td><%= p.usd_2009 %></td>
	    		<% if current_user && current_user.owner %>
		    		<td>
		    			<% if p.owner %>
	    					<% if p.owner == current_user.owner %>
	    						<%= link_to "Edit", edit_project_path(p) %>
	    					<% else %>
	    						Owner: <%= link_to p.owner.name, p.owner %> 
	    					<% end %>
	    				<% else %>
	    					No owner 
	    				<% end %>

	    			</td>
	    		<% else %>
	    		<td></td>
	    		<% end %>
	    	</tr>
	    <% end %>
	</tbody>
</table>
<%= will_paginate @projects %>
