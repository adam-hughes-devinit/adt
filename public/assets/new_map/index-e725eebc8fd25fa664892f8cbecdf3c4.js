((function(){this.App=this.App||{},App.svg=d3.select("#chart").append("svg:svg").attr("height","500px").attr("width","100%"),App.display_country=function(a){var b,c,d,e,f,g,h,i;return $(".country_name").text(a),App.this_country_data={aggregate:App.data.full.where({rows:function(b){return b.recipient_name===a}}),projects:new Miso.Dataset({url:"/projects.json\t\t\t\t?order_by=usd_2009\t\t\t\t&dir=desc\t\t\t\t&active_string=Active\t\t\t\t&max=10\t\t\t\t&country_name="+a})},App.this_country_data.by_year=App.this_country_data.aggregate.groupBy("year",["usd_2009"]),App.this_country_data.aggregate_json=App.this_country_data.by_year.toJSON(),App.this_country_data.projects.fetch({error:function(){return console.log("Couldn't get top projects")},success:function(){var a,b,c,d,e;b=this.toJSON(),console.log(b),c=$("#project_rows"),c.html("");for(d=0,e=b.length;d<e;d++)a=b[d],c.append(_.template($("#project_template").html(),a));return ApplySortability()}}),c=d3.scale.linear().domain([App.this_country_data.by_year.max("usd_2009")*1.1,App.this_country_data.by_year.min("usd_2009")]).range(["red","blue"]),i=d3.scale.linear().domain([App.this_country_data.by_year.max("usd_2009")*1.1,App.this_country_data.by_year.min("usd_2009")]).range([50,450]),g=d3.svg.axis().scale(i).orient("right").tickFormat(nice_money).ticks(4),h=App.svg.selectAll(".y_axis").data(App.this_country_data.aggregate_json),h.exit().remove(),h.enter().append("g").attr("class","y_axis").attr("transform","translate(10, 10)"),h.call(g),f=d3.scale.linear().domain([App.this_country_data.by_year.min("year"),App.this_country_data.by_year.max("year")]).range([50,$("#chart").width()-50]),d=d3.svg.axis().scale(f).tickFormat(function(a){return a}).orient("bottom"),e=App.svg.selectAll(".x_axis").data(App.this_country_data.aggregate_json),e.exit().remove(),e.enter().append("g").attr("class","x_axis").attr("transform","translate(10, 450)"),e.call(d),b=App.svg.selectAll(".bar").data(App.this_country_data.aggregate_json,function(a){return a.year}),b.enter().append("rect").attr("class","bar").style("cursor","pointer"),b.exit().remove(),b.transition().delay(function(a,b){return b*10}).attr("x",function(a,b){return""+f(a.year)+"px"}).attr("y",function(a){return""+i(a.usd_2009)+"px"}).attr("width","20px").attr("height",function(a){return""+(450-i(a.usd_2009))+"px"}).style("fill",function(a){return c(a.usd_2009)})}})).call(this),function(){var a=[].slice;this.log=function(){var b,c,d,e,f;c=1<=arguments.length?a.call(arguments,0):[],f=[];for(d=0,e=c.length;d<e;d++)b=c[d],f.push(console.log(b));return f},this.App=this.App||{},App.map=L.map("map").setView([0,23],3),App.layers={},L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Map data &copy; OpenStreetMap contributors",maxZoom:18}).addTo(App.map),App.collection=new Miso.Dataset({url:"/javascripts/collection_latlong.json",extract:function(a){return a.features}}),App.collection.fetch({error:function(){return alert("couldn't fetch countries")},success:function(){var a;return a=L.geoJson(this.toJSON(),{style:{weight:1,color:"#aaaaaa",fillOpacity:.45,clickable:!0},onEachFeature:function(a,b){return App.layers[a.properties.id]=b,b.on({mouseover:function(a){b=a.target,b.setStyle({weight:2,fillOpacity:.7});if(!L.Browser.ie&&!L.Browser.opera)return b.bringToFront},mouseout:function(a){return b=a.target,b.setStyle({weight:1,fillOpacity:.45})},click:function(a){var b;return b=a.target.feature.properties.name,App.display_country(b),App.map.fitBounds(a.target.getBounds())}})}}),a.addTo(App.map)}}),App.data={full:new Miso.Dataset({url:"/aggregates/projects?get=recipient_iso2,recipient_name,crs_sector_name,year",columns:[{name:"recipient_iso2",type:"string"},{name:"recipient_name",type:"string"},{name:"year",type:"number"},{name:"crs_sector_name",type:"string"},{name:"usd_2009",type:"number",before:function(a){return a==null?0:a}},{name:"count",type:"number",before:function(a){return a==null?0:a}}]})},App.data.full.fetch({error:function(){return alert("couldn't load finance data.")},success:function(){var a,b,c;return App.data.by_country=App.data.full.groupBy("recipient_iso2",["usd_2009"]),a=App.data.by_country,c=a.max("usd_2009"),b=d3.scale.linear().domain([0,c/3,c]).range(["#FAEDD9","#808F12","#2A5C0B"]),a.each(function(a){var c;if(c=App.layers[a.recipient_iso2])return c.setStyle({color:b(a.usd_2009)})})}})}.call(this);