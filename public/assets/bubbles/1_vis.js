((function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a){this.open_project_in_new_window=c(this.open_project_in_new_window,this),this.hide_details=c(this.hide_details,this),this.show_details=c(this.show_details,this),this.hide_flows=c(this.hide_flows,this),this.display_flows=c(this.display_flows,this),this.move_towards_flow=c(this.move_towards_flow,this),this.display_by_flow=c(this.display_by_flow,this),this.hide_years=c(this.hide_years,this),this.display_years=c(this.display_years,this),this.move_towards_year=c(this.move_towards_year,this),this.display_by_year=c(this.display_by_year,this),this.move_towards_center=c(this.move_towards_center,this),this.display_group_all=c(this.display_group_all,this),this.start=c(this.start,this),this.create_vis=c(this.create_vis,this),this.create_nodes=c(this.create_nodes,this);var b;this.data=a,this.width=940,this.height=600,this.readable=d3.format(",.0f"),$("body").append("<div class='tooltip' id='bubbletooltip' style='position:absolute;background-color: rgb(255, 255, 255); border: 1px solid rgb(128, 128, 128); opacity: 0.9; padding: 1px 5px;'></div>"),window.hideTooltip=function(){return $("#bubbletooltip").hide()},window.hideTooltip(),window.updatePosition=function(a){var b,c,d,e,f,g,h,i,j,k;return j=20,k=10,g=$("#bubbletooltip").width(),d=$("#bubbletooltip").height(),i=$(window).scrollTop(),h=$(window).scrollLeft(),b=document.all?a.clientX+h:a.pageX,c=document.all?a.clientY+i:a.pageY,e=b-h+j*2+g>$(window).width()?b-g-j*2:b+j,e<h+j&&(e=h+j),f=c-i+k*2+d>$(window).height()?c-d-k*2:c+k,f<i+k&&(f=c+k),$("#bubbletooltip").css("top",f+"px").css("left",e+"px")},window.showTooltip=function(a,b){return $("#bubbletooltip").html(a),$("#bubbletooltip").show(),window.updatePosition(b)},this.center={x:this.width/2,y:this.height/2},this.year_centers={2e3:{x:200,y:this.height/2},2001:{x:250,y:this.height/2},2002:{x:300,y:this.height/2},2003:{x:350,y:this.height/2},2004:{x:400,y:this.height/2},2005:{x:450,y:this.height/2},2006:{x:this.width-450,y:this.height/2},2007:{x:this.width-400,y:this.height/2},2008:{x:this.width-350,y:this.height/2},2009:{x:this.width-300,y:this.height/2},2010:{x:this.width-250,y:this.height/2},2011:{x:this.width-200,y:this.height/2}},this.flow_centers={"ODA-like":{x:300,y:this.height/2},"Vague (Official Finance)":{x:300,y:this.height/2},"OOF-like":{x:300,y:this.height/2},"CA -Gov":{x:this.width/2,y:this.height/2},"CA +Gov":{x:this.width/2,y:this.height/2},"FDI -Gov":{x:this.width/2,y:this.height/2},"FDI +Gov":{x:this.width/2,y:this.height/2},"JV -Gov":{x:this.width/2,y:this.height/2},"JV +Gov":{x:this.width/2,y:this.height/2},Military:{x:this.width-300,y:this.height/2},"NGO Aid":{x:this.width/2,y:this.height/2},"Vague (Com)":{x:this.width/2,y:this.height/2},"Official Investment":{x:300,y:this.height/2}},console.log(this.flow_centers),this.layout_gravity=-0.01,this.damper=.1,this.vis=null,this.nodes=[],this.force=null,this.circles=null,this.fill_color=d3.scale.ordinal().domain(["ODA-like","Vague (Official Finance)","OOF-like","Official Investment","NGO Aid","CA -Gov","CA +Gov","JV -Gov","JV +Gov","FDI -Gov","FDI +Gov","Vague (Com)","Military"]).range(["#3182bd","#65a5d3","#a5cae4","#9784e0","#5ce5cd","#5edf73","#49a959","#f7fc76","#f9e21b","#fd8d3c","#e6550d","#fe4444","#ff0000"]),b=d3.max(this.data,function(a){return parseInt(a.usd_defl)}),this.radius_scale=d3.scale.pow().exponent(.5).domain([0,b]).range([2,50]),this.create_nodes(),this.create_vis()}return a.prototype.create_nodes=function(){var a=this;return this.data.forEach(function(b){var c;return c={id:b.project_id,radius:a.radius_scale(parseInt(b.usd_defl)),value:parseInt(b.usd_defl),name:b.title,group:b.flow_class,year:b.year,recipient:b.recipient_condensed,sector:b.crs_sector_name,x:Math.random()*900,y:Math.random()*800},a.nodes.push(c)}),this.nodes.sort(function(a,b){return b.value-a.value})},a.prototype.create_vis=function(){var a,b=this;return this.vis=d3.select("#vis2").append("svg").attr("width",this.width).attr("height",this.height).attr("id","svg_vis"),this.legend=d3.select("div#legend").append("svg").attr("width",this.width/4).attr("height",this.height-55).attr("id","svg_vis"),this.circles=this.vis.selectAll("circle").data(this.nodes,function(a){return a.id}),a=this,this.circles.enter().append("circle").attr("r",0).attr("fill",function(a){return b.fill_color(a.group)}).attr("stroke-width",1).attr("stroke",function(a){return d3.rgb(b.fill_color(a.group)).darker()}).attr("id",function(a){return""+a.id}).style("curser","pointer").on("mouseover",function(b,c){return a.show_details(b,c,this)}).on("mouseout",function(b,c){return a.hide_details(b,c,this)}).on("click",function(b,c){return a.open_project_in_new_window(b,c,this)}),this.circles.transition().duration(2e3).attr("r",function(a){return a.radius})},a.prototype.charge=function(a){return-Math.pow(a.radius,2)/8},a.prototype.start=function(){return this.force=d3.layout.force().nodes(this.nodes).size([this.width,this.height])},a.prototype.display_group_all=function(){var a,b,c,d=this;return this.force.gravity(this.layout_gravity).charge(this.charge).friction(.9).on("tick",function(a){return d.circles.each(d.move_towards_center(a.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}),this.force.start(),b=d3.max(this.data,function(a){return parseInt(a.usd_defl)}),c=d3.min(this.data,function(a){return parseInt(a.usd_defl)}),a=[{r:this.radius_scale(d3.round(b,-9)),amount:this.readable(d3.round(b,-9))},{r:this.radius_scale(d3.round(b/2,-9)),amount:this.readable(d3.round(b/2,-9))},{r:this.radius_scale(d3.round(b/10,-7)),amount:this.readable(d3.round(b/10,-7))},{r:this.radius_scale(d3.round(c*1e3,-2)),amount:this.readable(d3.round(c*1e3,-2))}],this.legend.append("text").attr("x",0).attr("y",20).attr("id","legendtitle").attr("style","font-size:18;text-decoration:underline").text("Bubble Area - Project Value"),this.legend.selectAll("circle#example").data(a).enter().append("circle").attr("cx",function(a){return 5+a.r}).attr("cy",function(a){return 140-a.r}).attr("r",function(a){return a.r}).attr("fill","white").attr("style","stroke-dasharray: 2, 2").attr("stroke","black").attr("fill-opacity","1.0").attr("id","example").attr("stroke-opacity","0.5"),this.legend.selectAll("text#example").data(a).enter().append("text").attr("x",function(a){return 5+2*a.r}).attr("y",function(a){return 145-a.r}).attr("id","example").text(function(a){return"-----$"+a.amount}),this.legend.append("text").attr("x",60).attr("y",160).attr("id","example").text("Constant 2009 USD"),this.legend.append("text").attr("x",0).attr("y",190).attr("id","legendtitle").attr("style","font-size:18;text-decoration:underline").text("Bubble Color - Flow Class"),this.legend.selectAll("rect#example").data(d3.keys(this.flow_centers)).enter().append("rect").attr("fill",function(a){return d.fill_color(a)}).attr("x",0).attr("y",function(a,b){return 210+b*25}).attr("width",20).attr("id",function(a){return a}).attr("height",20).attr("rx",5).attr("ry",5).attr("stroke","black").attr("stroke-width",1),this.legend.selectAll("text#flowexamples").data(d3.keys(this.flow_centers)).enter().append("text").attr("x",25).attr("y",function(a,b){return 225+b*25}).attr("id","flowexamples").text(function(a){return a}),this.hide_years(),this.hide_flows()},a.prototype.move_towards_center=function(a){var b=this;return function(c){return c.x=c.x+(b.center.x-c.x)*(b.damper+.02)*a,c.y=c.y+(b.center.y-c.y)*(b.damper+.02)*a}},a.prototype.display_by_year=function(){var a=this;return this.force.gravity(this.layout_gravity).charge(this.charge).friction(.9).on("tick",function(b){return a.circles.each(a.move_towards_year(b.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}),this.force.start(),this.display_years(),this.hide_flows()},a.prototype.move_towards_year=function(a){var b=this;return function(c){var d;return d=b.year_centers[c.year],c.x=c.x+(d.x-c.x)*(b.damper+.02)*a*1.1,c.y=c.y+(d.y-c.y)*(b.damper+.02)*a*1.1}},a.prototype.display_years=function(){var a,b,c,d=this;return c={2e3:80,2011:this.width-50},b=d3.keys(c),a=this.vis.selectAll(".years").data(b),a.enter().append("text").attr("class","years").attr("x",function(a){return c[a]}).attr("y",100).attr("text-anchor","middle").text(function(a){return a})},a.prototype.hide_years=function(){var a;return a=this.vis.selectAll(".years").remove()},a.prototype.display_by_flow=function(){var a=this;return this.force.gravity(this.layout_gravity).charge(this.charge).friction(.9).on("tick",function(b){return a.circles.each(a.move_towards_flow(b.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}),this.force.start(),this.display_flows(),this.hide_years()},a.prototype.move_towards_flow=function(a){var b=this;return function(c){var d;return d=b.flow_centers[c.group],c.x=c.x+(d.x-c.x)*(b.damper+.02)*a*1.1,c.y=c.y+(d.y-c.y)*(b.damper+.02)*a*1.1}},a.prototype.display_flows=function(){var a,b,c,d=this;return c={Official:200,Unofficial:this.width/2,Military:this.width-200},b=d3.keys(c),a=this.vis.selectAll(".flows").data(b),a.enter().append("text").attr("class","flows").attr("x",function(a){return c[a]}).attr("y",100).attr("text-anchor","middle").text(function(a){return a})},a.prototype.hide_flows=function(){var a;return a=this.vis.selectAll(".flows").remove()},a.prototype.show_details=function(a,b,c){var d;return d3.select(c).attr("stroke","black"),d='<span class="tooltiptext">Title:</span><span class="value"> '+a.name+"</span><br/>",d+='<span class="tooltiptext">Amount:</span><span class="value"> $'+this.readable(a.value)+"</span><br/>",d+='<span class="tooltiptext">Recipient:</span><span class="value"> '+a.recipient+"</span><br/>",d+='<span class="tooltiptext">Year:</span><span class="value"> '+a.year+"</span><br/>",d+='<span class="tooltiptext">Flow Class:</span><span class="value"> '+a.group+"</span><br/>",d+='<span class="tooltiptext">Sector:</span><span class="value"> '+a.sector+"</span></br>",d+='<span class="tooltiptext">*Click to view project page</span>',showTooltip(d,d3.event)},a.prototype.hide_details=function(a,b,c){var d=this;return d3.select(c).attr("stroke",function(a){return d3.rgb(d.fill_color(a.group)).darker()}),hideTooltip()},a.prototype.open_project_in_new_window=function(a,b,c){return window.open("/projects/"+a.id)},a}(),b=typeof exports!="undefined"&&exports!==null?exports:this,$(function(){var c,d,e,f,g,h,i,j,k,l,m=this;return c=null,l=function(d){var e;return e=d.filter(function(a){return a.year>1999&&a.year<2012&&a.usd_defl!==""&&a.flow_class!==""&&a.crs_sector_name!==""}),c=new a(e),c.start(),b.display_all()},b.display_all=function(){return c.display_group_all()},b.display_year=function(){return c.display_by_year()},b.display_flow=function(){return c.display_by_flow()},b.toggle_view=function(a){return a==="year"?b.display_year():a==="flow"?b.display_flow():b.display_all()},h=1,i=120,g=2350,j=0,k=100/(g/i),d=[],$("#loading-bar .progress .bar").css("width","1%"),e=function(a,b,c,f){return d3.csv("/projects.csv?active_string=Active&page="+a+"&max="+b,function(g){return c+=f,$("#loading-bar .progress .bar").css("width",""+c+"%"),d=d.concat(g),g.length>=b?(a+=1,e(a,b,c,f)):($("#loading-bar").css("width","100%"),console.log("Found "+d.length+" active projects"),l(d),$("#loading-bar").slideUp().remove())})},f=function(){return d3.csv("/projects.csv?active_string=Active",function(a){return $("#loading-bar").css("width","100%"),console.log("Found "+a.length+" active projects"),l(a),$("#loading-bar").slideUp().remove()})},e(h,i,j,k)})})).call(this);