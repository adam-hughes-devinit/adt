<html>
  <head>
    <title>Nuclear 2</title>
    <script type='text/javascript' src="../../jquery-1.7.1.js"></script>
    <script type='text/javascript' src="../../d3/d3.v2.js"></script>
    <script type='text/javascript' src="data5.js"></script>
    <script type='text/javascript' src="disasters.js"></script>
    <style type="text/css">
    svg {background-color: #effce3}   
    </style>
  </head>
  <body>
    <div id='chart'></div>
        <script type='text/javascript'>
        
    var data = d3.layout.stack()
        //.offset()
        (data5);
    /*var data2 = d3.layout.stack()
        //.offset()
        (data5);*/
            
    var w = document.body.clientWidth-10,
        h = 500,
        x = d3.scale.linear().domain([1954, 2012]).range([10, w]),
        y = d3.scale.linear().domain([0,45]).range([0, h/2]),
        yy = d3.scale.linear().domain([0,500]).range([0, h])
        c = d3.scale.ordinal().domain([0,1,2,3,4,5]).range(["#fa2323","#245aff","#777","c74646","#4863b5","#555"])
        ;
    
    var y10= function(d) {return h/2 - y(d.y0) },
        y11= function(d) {return  h/2 - y(d.y) -y(d.y0) },
        y12= function(d) {return y(d.y)},
        y20= function(d) {return h/2 },
        y21= function(d,i) {return  h/2 + y(d.y0) - y(data[3][i].y0)},
        y22= function(d) {return y(d.y)}
    ;
        
    var svg = d3.select('#chart')
    .append("svg")
        .attr("width",  w)
        .attr("height", h);
        
    var layers = svg.selectAll('g.layer')
        .data(data)
    .enter().append('g')
        .attr("class", "layer")
        .attr("fill", function (d, i) {return c(i)})
        ;
        
    var plusbars = layers.selectAll('g.bar')
        .data(Object)
    .enter().append('g')
       .attr("class", "bar")
       .attr("transform", function(d) { "translate(" + x(d.x) + ", 0)"});
        

      

    
    var j = 0, // index in data (0-2)
        k= 0, // index in data.array (0-57)
        l= 0, // sum of data[j][k].y - data[j+2][k].y
        
        areadata = [[],[],[]]; // [[nondem total],[dem total], [unknown total]]
    
    for (j=0; j<=2; j++) {
      l =0;
      k =0;
      
    data[j].forEach(function() {
      l = (l + (data[j][k].y-data[j+3][k].y));
      areadata[j].push({"x" : 1954 + k, "y" : l});
      k++;
    });
    areadata[j].push({"x" : 1954 + k, "y" : l});
    };
    
  areadata = d3.layout.stack()(areadata);
        
  var area= d3.svg.area()
    .x(function(d) {return x(d.x);})
    .y0(function(d) {return h - yy(d.y0);})
    .y1(function(d) {return h - yy(d.y + d.y0);})
    .interpolate("linear")
        ;
   
    plusbars.append('rect')
        .attr("x", function(d, i) {return x(d.x)})
        .attr("y", h/2)
        .attr("width", w/70)
        .attr("height", 0)
        .attr("opacity", 1)
        .attr("stroke", "rgba(150,150,150,1)")
        //.on("mouseover", function(d) {alert(d.y)})
    .transition()
        .delay(function(d, i) {return i * 10})
        .attr("y", function(d, i) {return (d.yType=='start' ? y11(d) : y21(d, i))})
        .attr("height", function(d, i) {return (d.yType=='start' ? y12(d) : y22(d))})
        ;
  
  svg.selectAll('path')
        .data(areadata)
      .enter().append('g').append('g').append('path')
        .attr("class", function(d) {return d.x})
        .attr("d", area)
        .attr("fill", function(d, i) {return c(i)})
        //.attr("opacity", 0 )
        .attr("stroke", "rgba(150,150,150,1)")
      //.transition()
        //.delay(function(d, i) {return 1000 + (i*200)})
        //.duration(100)
        .attr("opacity", function(d,i) {return i==2 ? .2 :.2})
        ;
    
        
    svg.selectAll('areatick')
      .data(yy.ticks(10))
    .enter().append('line')
      .attr("class", "areatick")
      .attr("x1",w-20)
      .attr("x2",w)
      .attr("y1",yy)
      .attr("y2",yy)
      .style("stroke", "#555")
      ;
    
    svg.selectAll('.arearule')
      .data(yy.ticks(10))
    .enter().append('text')
      .attr("class", "arearule")
      .attr("x", w-15)
      .attr("y", yy)
      .attr("dy", -3)
      .attr("dx", -8)
      .attr("text-anchor", "start")
      .attr("font-size", ".8em")
      .text(function(d,i) {
        var totalplants=yy.ticks(10).reverse();
        return (totalplants[i]%100==0 ? totalplants[i]:"");
        })
      ;

//var barticks = d3.merge(y)
      
svg.selectAll('starttick')
      .data(y.ticks(10))
    .enter().append('line')
      .attr("class", "starttick")
      .attr("x1",0)
      .attr("x2",10)
      .attr("y1",y)
      .attr("y2",y)
      .style("stroke", "#555")
      ;
  svg.selectAll('startrule')
      .data(y.ticks(10))
    .enter().append('text')
      .attr("class", "startrule")
      .attr("x",4)
      .attr("y",y)
      .attr("dx", 3) // balancing the  -
      .attr("dy", -3)
      .attr("font-size", ".8em")
      .text(function (d, i) {
        var str=y.ticks(10).reverse();
        return str[i]==0 ? "" : str[i];})
      ; 
  svg.selectAll('stoptick')
      .data(y.ticks(10))
    .enter().append('line')
      .attr("class", "stoptick")
      .attr("x1",0)
      .attr("x2",10)
      .attr("y1",function(d) {return y(d) +h/2})
      .attr("y2",function(d) {return y(d) + h/2})
      .style("stroke", "#555")
      ;
 svg.selectAll('stoprule')
      .data(y.ticks(10))
    .enter().append('text')
      .attr("class", "stoprule")
      .attr("x",4)
      .attr("y",function(d) {return y(d) + h/2})
      .attr("dy", -3)
      .attr("font-size", ".8em")
      .text(function (d, i) {return (d==0||d>39) ? "" : "-" +d;})
      ; 
      
  var yearticks = 2011-1950;
 svg.selectAll('yeartick')
      .data(x.ticks(yearticks))
    .enter().append('line')
      .attr("class", "yeartick")
      .attr("x1",x)
      .attr("x2",x)
      .attr("y1",h-40)
      .attr("y2",h-30)
      .style("stroke", "#555");
      
svg.selectAll('.yearrule')
      .data(x.ticks(yearticks))
    .enter().append('text')
      .attr("class", "yearrule")
      .attr("x", x)
      .attr("y", h)
      .attr("dy", -3)
      .attr("text-anchor", "start")
      .attr("font-size", ".7em")
      .attr("transform", function(d) {return "rotate(-90,"+ (x(d)+1) +", "+(h-5)+")"})
      .text(function(d) {return d%5==0 ? d: ""})
       ;
svg.append('text')
  .attr("x", w/3)
  .attr("y", 20)
  .text("Nuclear Reactors Worldwide, by Democracy Level")
 
 var disaster=svg.selectAll('.disaster')
    .data(disasters)
    ;
  
  disaster.enter().append('circle')
    .attr("cy", h/2)
    .attr("cx", function(d) {return x(d.x)})
    .attr("r", 0)
    .attr("fill", "#98ED00")
    .attr("stroke","#639a00")
    .attr("opacity", .5)
  .transition()
    .delay(function(d, i) {return 600 + ((d.x-1900)*10)})
    .attr("r", function(d) {return Math.pow(d.ines,2)/2})
    ;
  
  disaster.append('title')
    .text(function(d) {return d.name + " ("+d.x+")"});

// LEGEND
var legend=[["Non-Democratic", "Democratic", "No Data"],
            ["Yearly Starts", "Yearly Stops", "Running Total"],
            ["Disaster, by INES score (4-7)"]]
var legendcolors = [["#fa2323","#245aff","#777"],[.8,.6,.2]]
            
svg.selectAll('.legend1')
  .data(legend[0])
.enter().append('text')
  .attr("class", "legend1")
  .attr("x",w/10)
  .attr("y",function(d, i) {return 65 + i*20})
  .attr("text-anchor", "middle")
  .attr("fill", function(d,i) {return legendcolors[0][i]})
  .text(String)
  ;
  
svg.selectAll('.legend2')
  .data(legend[1])
.enter().append('text')
  .attr("class", "legend2")
  .attr("x",w/10)
  .attr("y",function(d, i) {return 325 + i*20})
  .attr("text-anchor", "middle")
  .attr("opacity", function(d,i) {return legendcolors[1][i]})
  .text(String)
  ;
svg.selectAll('.legend3')
  .data(legend[2])
.enter().append('text')
  .attr("class", "legend3")
  .attr("x",w/10)
  .attr("y",function(d, i) {return 405 + i*20})
  .attr("text-anchor", "middle")
  .attr("fill", "#639a00")
  .text(String)
  ;
      </script>
       
    
  </body>