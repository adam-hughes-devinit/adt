<html>
  <head>
    <title>AidData Purpose Codes</title>
    
    <script type="text/javascript" src="../jquery-1.7.1.js"></script>
    <script type='text/javascript' src="../d3/d3.v2.js"></script>
    <script type='text/javascript' src="pc_nodes.js"></script>
    <style type='text/css'>
    </style>
    <body>
    <div>
    <a href='#' id='fwd'>FWD</a>
    ||<a href='#' id='rev'>REV</a>
    ||<a href='#' id='rnd'>RND</a>
    ||<a href='#' id='rpt'>RPT</a>
    ||<a href='#' id='cyc'>CYC</a>
    </div>
    <div id='chart'></div>
    <script type="text/javascript">
var  j=1,
    w = 840,
    h = w,
    r = w / 2,
    x = d3.scale.linear().range([0, 2 * Math.PI]),
    y = d3.scale.pow().exponent(1.3).domain([0,0,1]).range([0,1, r]),
    p = 5,
    c = d3.scale.linear().range(['#ddd', 'red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'])
    .domain([0, 1, 250/6, 2*(250/6), 3*(250/6),4*(250/6),5*(250/6), 6*(250/6), ]),
    duration = 500,
    minWedge = .075;

function revColor (c) {
  if (c==0) {return '#ddd'}
  else if (c>230&&c<=255) {
    newColor = d3.scale.linear().range(['violet','indigo']).domain([231, 255])
  }
  else if (c>203&&c<=230) {
    newColor = d3.scale.linear().range(['indigo','royalblue']).domain([204, 230])
  }
  else if (c>183&&c<=203) {
    newColor = d3.scale.linear().range(['royalblue','springgreen']).domain([184, 203])
  }
  else if (c>123&&c<=183) {
    newColor = d3.scale.linear().range(['green','yellow']).domain([124, 183])
  }
    else if (c>81&&c<=123) {
    newColor = d3.scale.linear().range(['yellow','orange']).domain([82, 123])
  }
  else if (c>0&&c<=81) {
    newColor = d3.scale.linear().range(['red','yellow', 'red']).domain([1,2, 81])
  }
  return newColor(c);
}

var vis = d3.select("#chart")
    .append("svg")
        .attr("width", w + p * 2)
        .attr("height", h + p * 2)
  .append("g")
    .attr("transform", "translate(" + (r + p) + "," + (r + p) + ")");   

var partition = d3.layout.partition()
    .sort(null)
    .value(function(d) { return 5.8 - d.depth; });
    
var nodes = partition.nodes({children: purposeCodes})
    ;

var arc = d3.svg.arc()
    .startAngle(function(d,i) {
      //console.log(i+ ' -- ' +d.x + ' -- ' + (x(d.dx))/2);
      return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
    .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
    .innerRadius(function(d,i) {
      /*console.log(i+ ' -- ' +d.y + ' / ' + d.dy + ' -- ' + y(d.y) + ' / ' + y(d.dy));*/
      return Math.max(0, d.y ? y(d.y) : 0);
      //return d.depth==1 ? 40 : Math.max(0, d.y ? y(d.y) : 0);
      })
    .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

var path = vis.selectAll("path").data(nodes);
  path.enter().append("path")
      .attr("id", function(d, i) { return "path-" + i; })
      .attr("class", "wedge")
      .attr("d", arc)
      .attr("fill-rule", "evenodd")
      .style("fill", function(d, i) {return revColor(i);})
      .style("stroke", "#000")
      .style("stroke-weight", .5)
      .style("cursor", "pointer")
      .on("click", click)
      .on("mouseover", mOver)
      .on("mouseout", function (){$(".ttp").hide('slow', function() {$(".ttp").remove();})})
  .append('ttp')
    .text(function(d, i) {return d.code + ': '+d.name });

var text = vis.selectAll("text").data(nodes);
  var textEnter = text.enter().append("text")
  .attr("id", function(d, i) { return "text-" + i; })
      .style("visibility", function(d) {return (Math.abs(x(d.dx))>minWedge) ? 'visible' : 'hidden'})
      .attr("text-anchor", function(d) {
        return x(d.x + d.dx / 2) > Math.PI ? "end" : "start";
      })
      .attr("dy", ".2em")
      .attr("transform", function(d) {
        var angle = x(d.x + d.dx / 2) * 180 / Math.PI - 90,
            rotate = angle;
        return "rotate(" + rotate + ")translate(" + (y(d.y) + p) + ")rotate(" + (angle > 90 ? -180 : 0) + ")";
      })
      .on("click", click)
      .style("cursor", "pointer")
 // .append('title')
 //     .text(function(d) {return d.name});
      
  textEnter.append("tspan")
      .attr("x", 0)
      .text(function(d) { return d.depth ? d.code: ""; });
   
      
function click(d) {
    clearInterval(rpt);
    clearInterval(cyc);
    
    path.transition()
      .duration(duration)
      .attrTween("d", arcTween(d));
    text
      .transition().duration(duration)
      .attrTween("text-anchor", function(d) {
        return function() {
          return x(d.x + d.dx / 2) > Math.PI ? "end" : "start";
        };
      })
      .attrTween("transform", function(d) {
        return function() {
          var angle = x(d.x + d.dx / 2) * 180 / Math.PI - 90,
              rotate = angle;
          return "rotate(" + rotate + ")translate(" + (y(d.y) + p) + ")rotate(" + (angle > 90 ? -180 : 0) + ")";
        };})
;
window.setTimeout (function(){
  text.style("visibility", function(e,i) {
        if (isParentOf(d, e) && Math.abs(x(e.dx))>minWedge){return 'visible';}
        else {return 'hidden';}
        })}, (duration+5))
  }
  
function arcTween(d) {
  var my = maxY(d),
      xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
      yd = d3.interpolate(y.domain(), [d.y, my]),
      yr = d3.interpolate(y.range(), [d.y ? 20 : 0, r]);
  return function(d) {
    return function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
  };
}

function maxY(d) {
  return d.children ? Math.max.apply(Math, d.children.map(maxY)) : d.y + d.dy;
}

function isParentOf(p, c) {
  if (p === c) return true;
  if (p.children) {
    return p.children.some(function(d) {
      return isParentOf(d, c);
    });
  }
  return false;
}


function mOver () {
    ttp = $(this).children().text()
    mouse = d3.mouse(this)
  tooltip = vis.selectAll('.ttp')
      .data([ttp])
      .enter().append('g')
        .attr('class', 'ttp')
        .attr('background', '#ff0033')
        ;
  
  xAnchor = mouse[0],
  yAnchor = mouse[1]-20;
  
  tooltip.append('text')
      .attr('id', 'ttpText')
      .text(String)
      .attr("x", xAnchor )
      .attr("y", yAnchor)
      .attr("text-anchor", "start")
      .attr("background", "#f01040")

  tWidth = d3.selectAll('#ttpText').node().getComputedTextLength()
  
  tooltip.insert('rect','#ttpText')
      .attr('width', tWidth +20 )
      .attr('height', '1.3em')
      .attr('x', xAnchor-10)
      .attr('y', yAnchor - 16)
      .style('fill', 'hsla(360,0%,100%, .8)')
      .style('stroke', '#000')
      .style('stroke-weight', '1px')
    //console.log(ttp)  
      }

$('#path-0').children().text('All')
$('#fwd').click(function (){
    clearInterval(rpt);
    clearInterval(cyc);
  path.transition()
    .duration(duration).style("fill", function(d, i) {return c(i);})
  });
$('#rev').click(function (){
    clearInterval(rpt);
    clearInterval(cyc);
  path.transition()
    .duration(duration)
    .style("fill", function(d, i) {return revColor(i);})
  });
$('#rnd').click(function (){
    clearInterval(rpt);
    clearInterval(cyc);
  path.transition()
    .duration(duration).style("fill", function(d, i) {return c(Math.random()*250)})
  });
$('#rpt').click(function (){
    clearInterval(rpt);
    clearInterval(cyc);
  rpt = setInterval(function() {
      path.transition()
    .duration(100).style("fill", function(d, i) {return c(Math.random()*250)})
  }, 100);
})
$('#cyc').click(function (){
    clearInterval(rpt);
    clearInterval(cyc);

 cycColor = d3.scale.linear()
      .range(['#ddd', 'red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'purple', 'red'])
     .domain([0, 1, 250/7, 2*(250/7), 3*(250/7),4*(250/7),5*(250/7), 6*(250/7), 250 ]);

path.transition()
    .duration(duration).style("fill", function(d, i) {return i==0 ? cycColor(0) : cycColor(((i+j) % 249) +1)})
 
    
 cyc = setInterval(function() {
      path.transition()
    .duration(35).style("fill", function(d, i) {return i==0 ? cycColor(0) : cycColor(((i+j) % 249) +1)})
  j++;
  
  }, 60);
})
 ;

    </script>
    </head>
    
    </body>