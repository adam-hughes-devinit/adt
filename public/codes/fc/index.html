<html>
  <head>
    <title>FC JSON test</title>
    <script type='text/javascript' src="../jquery-1.7.1.js"></script>
    <script type="text/javascript" src="../js/jquery-ui-1.8.18.custom.min.js"></script>
    <script type='text/javascript' src="../d3/d3.v2.js"></script>
    <script type='text/javascript' src="variables.js"></script>
	<link type="text/css" href="../css/custom-theme/jquery-ui-1.8.18.custom.css" rel="stylesheet" />
    <style type="text/css">
    </style>
<script type='text/javascript'>
   var iso3 ='KEN' ,
     adtcode= '120',
     url= "http://gisdev.foundationcenter.org/aiddata/getAggregatedGrantsByCountryAndSubject.php?"  

     
</script>
  </head>
  <body>
    <div class="ui-widget">
    <div id='chart'></div>
    <form id='params'>
<label for='isopicker'>ISO3:</label>
<input id='isopicker' /> <button id='isobutton'>GO</button>
</form>
<script type='text/javascript'>
$(function (){
     

getFC(iso3,adtcode,url);
  
$('#isopicker').autocomplete({
                source: iso3choices
            });
$('#isobutton').click(function() {
  
  iso3=document.getElementById('isopicker').value;
  iso3='HTI'
  alert(iso3 +" // " + adtcode + " // " + url);
  getFC(iso3, adtcode, url);
  
});
 
var data= ''

function getFC(iso3, adtcode, url) {
  alert(iso3 +" // " + adtcode + " // " + url);

  $.ajax({
    url: url,
    cache: false,
    type: "GET",
    data: {
      iso3 : iso3,
      adtcode : adtcode
    },
    success: function(json) {
      json = json.replace("query results", "results")
     // alert(json);
      data = jQuery.parseJSON(json);
     // alert('success: ' + data.source + " " + data.results)
      drawGraph();
    },
    error: function(a, b, c) {
      alert(a.statusText + " // " + b + ' // ' + c)
      return
    }
    })
}
  
  var w = 700
  var h = 500
  var adt = ['110', '120', '130', '140', '150', '160', '210', '220', '230', '240', '250', '310', '320',
             '330', '410', '420', '430', '510', '520', '530', '600', '700', '910', '920', '930', '998']
  var adt_c = ["#0f0", "#f00", "#00f","#0f0", "#f00", "#00f","#0f0", "#f00", "#00f","#0f0", "#f00", "#00f",
                "#0f0", "#f00", "#00f","#0f0", "#f00", "#00f","#0f0", "#f00", "#00f","#0f0", "#f00", "#00f",
                "#0f0", "#f00"]
  
  var x = d3.scale.linear().domain([2004, 2011]).range([0,w]),
      y = d3.scale.linear().domain([0,100000000]).range([0,h]),
      c = d3.scale.ordinal().domain(adt).range(adt_c)
        
function drawGraph () {
  //alert('drawgraph')
  var svg = d3.select('#chart')
    .append("svg")
    .attr("width",  w)
    .attr("height", h);
    
  var bar = svg.selectAll('.flow')
      .data(data.results)
    .enter().append('rect')
      .attr("x", function(d) {return x(d.year)})
      .attr("y", function(d) {return h - y(parseInt(d.grant_amount))})
      .attr("height", function (d) {return y(parseInt(d.grant_amount))})
      .attr("width", w/8)
      .attr("fill", function(d) {return c(d.adt_code)})
      ;
  
  }
  
});  
  
     
</script>
    </div>
  </body>